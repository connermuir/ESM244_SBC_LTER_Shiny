---
title: "Tab 1 - Satellite Kelp Data"
author: "Conner Smith"
date: "2/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ncdf4)
library(tidyverse)
library(sf)
library(raster)
library(rgdal)
library(here)
library(tmap)
library(stars)
```

```{r}
## Read in the dataset from: https://portal.edirepository.org/nis/mapbrowse?scope=knb-lter-sbc&identifier=74.

## This is time series data of kelp canopy using satellite imagery and will be updated regularly. The file is a .ns so we use the 'ncdf4' package. 

## HELP: Need to read this direct off web

nc_kelp_raw <- nc_open(here("data", "LandsatkelpBiomass_2021_v2_withmetadata.nc"))

year <-ncvar_get(nc_kelp_raw,"year")
quarter <- ncvar_get(nc_kelp_raw,"quarter")
  
lon <- ncvar_get(nc_kelp_raw,"longitude")
lat <- ncvar_get(nc_kelp_raw,"latitude")
biomass<-ncvar_get(nc_kelp_raw,"biomass") 


time<-data.frame(year,quarter)

# Now we have the time data in its own data frame thanks to Li, 152 is the time stamp for Q4 of 2021


df_li <- data.frame(lat,lon,biomass=data.frame(biomass)[,152]) %>%
  filter(!is.na(biomass)) %>%
  filter(lat>=33.847062&lat<=34.100458&lon>=-120.291726&lon<=-119.924374) %>%
  filter(biomass > 0) # too many values if 0s are included 

print(df_li)

write.csv(df_li, 'C:\\Users\\conne\\Documents\\ESM 244\\Shiny\\ESM244_SBC_LTER_Shiny\\data\\santa_cruz_kelp_2021.csv', row.names = FALSE)

# Providing a coordinate range for SB region (this may actually just be the islands), still has some NAs, can't drop_na or all observations disappear 

#create a csv for this 

# try to make a sf and fixed map from this 

kelp_sat_sf <- df_li %>% 
  st_as_sf(coords = c('lon', 'lat'))

st_crs(kelp_sat_sf) <- 4326


tmap_mode('view') 
tmap_kelp_sat <- 
  tm_shape(kelp_sat_sf) +
  tm_legend(title = "Santa Cruz Kelp Biomass in 2021 (kg)") +
  tm_dots('biomass', palette = 'BuGn')
tmap_kelp_sat

#This works! Kelp values for one quarter/year on santa rosa 


```


```{r}
# Placeholder map data until .ns can be figured out 

# This is the kelp biomass from all sites, will bind the coordinates for the sites after 

kelp_raw_sites <- read_csv(here('data', 'kelp_no3_waves.csv'))

sites <- read_csv(here('data', 'site_locations.csv'))

combined_kelp <- merge(sites, kelp_raw_sites, by = "site_id")

# This worked! We now have a proxy for kelp biomass by site including coordinates. 
```

```{r}
# Now we want to map this kelp across the sites using the 'sf' package 

#First filter for jsut the SB coordiantes:

combined_kelp_sb <- combined_kelp %>% 
  filter(site_id %in% c(267:298)) %>% 
  group_by(site_id)

kelp_sb_sf <- combined_kelp_sb %>% 
  st_as_sf(coords = c('lon', 'lat'))

# we need to tell R what the coordinate reference system is 

st_crs(kelp_sb_sf) <- 4326

ggplot(data = kelp_sb_sf) +
  geom_sf(color = 'darkgreen') +
  theme_minimal()

# Reading in the coastal polygon shp file for SB from here: http://geodata.library.ucsb.edu/catalog/3853-s3_2002_s3_reg_coastal 

sb_map <- read_sf(here('data', 'coastal_map',
                       '3853-s3_2004_s3_coastal_zone.shp'))

sb_map_transform <- st_transform(sb_map, 4326)

ggplot(data = sb_map_transform) +
  geom_sf()

# Kick ass, we have the coastal zone shp file now. Note: this is for the entire county so we may need to filter it somehow or jsut include more kelp sites. 

# Now make a combined plot with all the data:

sb_map_static <- ggplot() +
  geom_sf(data = sb_map,
          size = .1,
          color = 'darkgrey') +
  geom_sf(data = kelp_sb_sf,
          size = .5,
          color = 'red') +
  theme_void() +
  labs(title = 'Kelp Cover in Santa Barbara')

# Using tmap from the lab

tmap_mode('view') 
tmap_kelp <- tm_shape(kelp_sb_sf) +
  tm_dots()

tmap_kelp

# THIS IS A FUNCTIONAL MAP FEATURE!!! 

# NEXT THING TO FIGURE OUT: LOADING NS, CREATING WEIGHTINGS/COLOR BASED ON KELP DENSITY AND INCLUDING TIME SERIES FILTER 
```

