---
title: "Kelp Factors"
author: "Conner Smith"
date: "2/2/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(cowplot)
library(plotly)
library(data.table)
library(lubridate)
```

```{r}
# read in the first data sets

kelp_factors <- read_csv(here("data", "kelp_no3_waves.csv"))

kelp_abund <- read_csv(here('data', 'annual_kelp.csv'))

```


```{r}
kelp_abund_sub <- kelp_abund %>%
  clean_names() %>% 
  mutate(site = case_when(site == 'CARP' ~ 'Carpinteria',
                          site == 'NAPL' ~ 'Naples',
                          site == 'MOHK' ~ 'Mohawk',
                          site == 'IVEE' ~ 'Isla Vista',
                          site == 'AQUE' ~ 'Arroyo Quemado',
                          site == 'ABUR' ~ 'Arroyo Burro',
                          site == 'AHND' ~ 'Arroyo Hondo',
                          site == 'SCTW' ~ 'Santa Cruz - Harbor',
                          site == 'SCDI' ~ 'Santa Cruz - Diablo',
                          site == 'BULL' ~ 'Bulito',
                          site == 'GOLB' ~ 'Goleta Bay')) %>% 
  group_by(site) %>% 
  na_if(-99999) %>% 
  drop_na()

kelp_abundance <- ggplot(data = kelp_abund_sub, 
                       aes(x = year, y = fronds)) +
  geom_col(fill = "darkseagreen") +
  theme_minimal() +
  labs(title = "Kelp Abundance Over Time", 
       x = "Year", y = "Kelp Fronds (number > 1m)")
kelp_abundance

# this is the graph for specific LTER sites 
```

```{r}
# This takes data collected across CA and filters down fro SB site range 
# The range DOES NOT include islands sites 

kelp_factors_sub <- kelp_factors %>% 
  filter(site_id %in% c(267:298)) %>% 
  group_by(site_id, year)

kelp_biomass_plot <- ggplot(data = kelp_factors_sub, 
                       aes(x = year, y = kelp)) +
  geom_col(fill = "darkseagreen") +
  theme_minimal() +
  labs(title = "\nKelp Biomass Over Time\n", 
       x = "Year", y = "\nKelp Biomass (kg)\n")

no3_plot <- ggplot(data = kelp_factors_sub, 
                       aes(x = year, y = no3)) +
  geom_smooth(color = "coral") +
  theme_minimal() +
  labs(title = "\nNitrate Concentration Over Time\n", 
       x = "Year", y = "\nNitrate COncentration (uM/L)\n")
no3_plot

nitrate_kelp <- plot_grid (kelp_biomass_plot, no3_plot)
nitrate_kelp

# Now we will try to show these on the same plot with different y axes 

#First we need to estimate a scaling coefficient between the numbers, kelp biomass numbers generally 4 orders of magnitude larger (e.g. 10^7)

coeff <- 10^7
#This is the best scaling factor after trying a few 

combined_no3 <- ggplot(data = kelp_factors_sub, 
                       aes(x = year, y = no3)) +
  # now integrate the nitrogen curve with the kelp
  geom_smooth(color = "coral") + #now we need to scale the kelp axis  
  geom_col(aes(y = kelp/coeff), fill = "darkseagreen", alpha = 0.7) +
  scale_y_continuous(
    # Features of the first axis
    name = "NO3 Concentration (uM/L)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name=" Kelp Biomass (kg)")
  ) +
  theme_bw()
```

```{r}
# Creating anothe rgraph for wave height 

combined_waves <- ggplot(data = kelp_factors_sub, 
                       aes(x = year, y = waves)) +
  # now integrate the wave curve with the kelp
  geom_smooth(color = "cadetblue3") + #now we need to scale the kelp axis  
  geom_col(aes(y = kelp/coeff), fill = "darkseagreen", alpha = 0.7) +
  scale_y_continuous(
    # Features of the first axis
    name = "Average Wave Height (m)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name=" Kelp Biomass (kg)")
  ) +
  theme_bw()
ggplotly(combined_waves)

```

```{r}
# Attempting to pull temp data from link: 

temp_big <- fread('https://pasta.lternet.edu/package/data/eml/knb-lter-sbc/13/26/d707a45a2cd6eee1d016d99844d537da')

# This worked: Note: fread was much faster then read_csv

temp_sub <- temp_big %>% 
  clean_names() %>% 
  dplyr::select(site, date_local, temp_c) %>% 
  mutate(month = month(date_local)) %>% 
  mutate(year = year(date_local))
  
temp_sum <- temp_sub %>% 
  group_by(month, year) %>% 
  summarize(month_avg = mean(temp_c))
  
```

